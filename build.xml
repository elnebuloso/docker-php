<?xml version="1.0" encoding="UTF-8"?>

<project name="application" basedir="." default="commons:help">


    <property file="build.properties"/>
    <property file="build.properties.local"/>


    <import file="/srv/phing/commons/standard.xml"/>


    <target name="build:all:official">
        <property name="command" value="build"/>
        <phingcall target="run:7.1-apache"/>
        <phingcall target="run:7.1-cli"/>
    </target>


    <target name="build:all:ubuntu">
        <property name="command" value="build"/>
        <phingcall target="run:7.1-apache-ubuntu"/>
        <phingcall target="run:7.1-cli-ubuntu"/>
        <phingcall target="run:7.2-apache-ubuntu"/>
        <phingcall target="run:7.2-cli-ubuntu"/>
        <phingcall target="run:7.3-apache-ubuntu"/>
        <phingcall target="run:7.3-cli-ubuntu"/>
    </target>


    <target name="run:7.1-apache">
        <phingcall target="${command}">
            <property name="release" value="official"/>
            <property name="version" value="7.1"/>
            <property name="type" value="apache"/>
            <property name="image.version" value="${version}-${type}"/>
            <property name="image" value="${project.name}:${version}-${type}"/>
        </phingcall>
    </target>


    <target name="run:7.1-cli">
        <phingcall target="${command}">
            <property name="release" value="official"/>
            <property name="version" value="7.1"/>
            <property name="type" value="cli"/>
            <property name="image.version" value="${version}-${type}"/>
            <property name="image" value="${project.name}:${version}-${type}"/>
        </phingcall>
    </target>


    <target name="run:7.1-apache-ubuntu">
        <phingcall target="${command}">
            <property name="release" value="ubuntu"/>
            <property name="version" value="7.1"/>
            <property name="type" value="apache"/>
            <property name="image.version" value="${version}"/>
            <property name="image" value="${project.name}:${version}-${type}-${release}"/>
        </phingcall>
    </target>


    <target name="run:7.1-cli-ubuntu">
        <phingcall target="${command}">
            <property name="release" value="ubuntu"/>
            <property name="version" value="7.1"/>
            <property name="type" value="cli"/>
            <property name="image.version" value="${version}"/>
            <property name="image" value="${project.name}:${version}-${type}-${release}"/>
        </phingcall>
    </target>


    <target name="run:7.2-apache-ubuntu">
        <phingcall target="${command}">
            <property name="release" value="ubuntu"/>
            <property name="version" value="7.2"/>
            <property name="type" value="apache"/>
            <property name="image.version" value="${version}"/>
            <property name="image" value="${project.name}:${version}-${type}-${release}"/>
        </phingcall>
    </target>


    <target name="run:7.2-cli-ubuntu">
        <phingcall target="${command}">
            <property name="release" value="ubuntu"/>
            <property name="version" value="7.2"/>
            <property name="type" value="cli"/>
            <property name="image.version" value="${version}"/>
            <property name="image" value="${project.name}:${version}-${type}-${release}"/>
        </phingcall>
    </target>


    <target name="run:7.3-apache-ubuntu">
        <phingcall target="${command}">
            <property name="release" value="ubuntu"/>
            <property name="version" value="7.3"/>
            <property name="type" value="apache"/>
            <property name="image.version" value="${version}"/>
            <property name="image" value="${project.name}:${version}-${type}-${release}"/>
        </phingcall>
    </target>


    <target name="run:7.3-cli-ubuntu">
        <phingcall target="${command}">
            <property name="release" value="ubuntu"/>
            <property name="version" value="7.3"/>
            <property name="type" value="cli"/>
            <property name="image.version" value="7.3"/>
            <property name="image" value="${project.name}:${version}-${type}-${release}"/>
        </phingcall>
    </target>


    <target name="build">
        <echo message="release:       ${release}"/>
        <echo message="version:       ${version}"/>
        <echo message="type:          ${type}"/>
        <echo message="image.version: ${image.version}"/>
        <echo message="image:         ${image}"/>
        <echo message=""/>

        <exec command="docker build --pull --tag ${image} --build-arg PHP_VERSION=${image.version} --file release/${release}/${type}/Dockerfile ." passthru="true" checkreturn="true" level="info" dir="${project.root}"/>
        <exec command="docker run -i --rm -v /var/run/docker.sock:/var/run/docker.sock -v ${project.root}:/app zemanlx/container-structure-test:v1.7.0-alpine test --image ${image} --config /app/release/${release}/all/tests/structure.yaml" passthru="true" checkreturn="true" level="info" dir="${project.root}"/>
        <exec command="docker run -i --rm -v /var/run/docker.sock:/var/run/docker.sock -v ${project.root}:/app zemanlx/container-structure-test:v1.7.0-alpine test --image ${image} --config /app/release/${release}/all/tests/structure-${type}.yaml" passthru="true" checkreturn="true" level="info" dir="${project.root}"/>
    </target>


    <target name="run" depends="build">
        <exec command="docker run --publish 80:80 --volume ${project.root}/main:/var/www ${image}" passthru="true" checkreturn="true" level="info" dir="${project.root}"/>
    </target>


    <target name="push" depends="build">
        <exec command="docker run ${image} php --version" passthru="false" checkreturn="true" outputProperty="container.php.version" level="info" dir="${project.root}"/>

        <adhoc-task name="semver"><![CDATA[
            class FooTest extends Task {
                private $version;
                private $outputProperty;

                function setVersion($version) {
                    $this->version = $version;
                }

                function setOutputProperty($outputProperty) {
                    $this->outputProperty = $outputProperty;
                }

                function main() {
                    if(preg_match('#(PHP ((\d{1,}).(\d{1,}).(\d{1,})))#', $this->version, $matches)) {
                        $this->getProject()->setProperty($this->outputProperty, trim($matches[2]));
                        return;
                    }

                    throw new BuildException('cannot parse semver');
                }
            }
        ]]></adhoc-task>

        <semver version="${container.php.version}" outputProperty="semver"/>

        <if>
            <equals arg1="${release}" arg2="official"/>
            <then>
                <property name="docker.hub.tag1" value="elnebuloso/${project.name}:${semver}-${type}" override="true"/>
                <property name="docker.hub.tag2" value="elnebuloso/${project.name}:${version}-${type}" override="true"/>
            </then>
        </if>

        <if>
            <equals arg1="${release}" arg2="ubuntu"/>
            <then>
                <property name="docker.hub.tag1" value="elnebuloso/${project.name}:${semver}-${type}-${release}" override="true"/>
                <property name="docker.hub.tag2" value="elnebuloso/${project.name}:${version}-${type}-${release}" override="true"/>
            </then>
        </if>

        <exec command="docker tag ${image} ${docker.hub.tag1}" passthru="true" checkreturn="true" level="info" dir="${project.root}"/>
        <exec command="docker tag ${image} ${docker.hub.tag2}" passthru="true" checkreturn="true" level="info" dir="${project.root}"/>

        <!--<exec command="docker push ${docker.hub.tag1}" passthru="true" checkreturn="true" level="info" dir="${project.root}"/>-->
        <!--<exec command="docker push ${docker.hub.tag2}" passthru="true" checkreturn="true" level="info" dir="${project.root}"/>-->
    </target>


</project>
